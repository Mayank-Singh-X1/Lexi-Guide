<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LexiGuard - Your Document AI Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #f9f9f9; --text-color: #333; --header-color: #4a4a4a;
            --container-bg: #fff; --container-border: #ddd; --pre-bg: #f4f4f4;
            --button-bg: #007bff; --button-hover-bg: #0056b3;
        }
        [data-theme="dark"] {
            --bg-color: #121212; --text-color: #e0e0e0; --header-color: #f5f5f5;
            --container-bg: #1e1e1e; --container-border: #444; --pre-bg: #2c2c2c;
            --button-bg: #0d6efd; --button-hover-bg: #0a58ca;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; line-height: 1.6; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        h1, h2, h3 { color: var(--header-color); }
        .container, .auth-container, .dashboard-container, .feature-container { background-color: var(--container-bg); border: 1px solid var(--container-border); padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; transition: background-color 0.3s; }
        .hidden { display: none; }
        #loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--button-bg); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        pre { white-space: pre-wrap; word-wrap: break-word; background-color: var(--pre-bg); padding: 15px; border-radius: 5px; border: 1px solid var(--container-border); transition: background-color 0.3s; }
        button { background-color: var(--button-bg); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: background-color 0.2s, transform 0.2s; }
        button:hover { background-color: var(--button-hover-bg); transform: translateY(-1px); }
        input, select, textarea { padding: 8px; border: 1px solid var(--container-border); border-radius: 4px; margin-right: 10px; margin-bottom: 10px; background-color: var(--container-bg); color: var(--text-color); width: 95%; }
        select { width: auto; }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .theme-switch, .help-button { font-size: 24px; cursor: pointer; user-select: none; }
        .legal-term { color: #007bff; border-bottom: 1px dotted #007bff; cursor: help; }
        .tour-step { position: fixed; background: var(--container-bg); color: var(--text-color); padding: 20px; border-radius: 8px; max-width: 350px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1000; border: 1px solid var(--container-border); }
        .tour-nav { margin-top: 15px; display: flex; justify-content: space-between; }
        .upload-controls { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        .analysis-section { margin-top: 25px; }
        .risk-analysis { border-left: 4px solid #d9534f; }
        .summary-analysis { border-left: 4px solid #5cb85c; }
        .missing-analysis { border-left: 4px solid #f0ad4e; }
        .auth-form input { width: 95%; }
        #auth-toggle { color: #007bff; cursor: pointer; text-decoration: underline; }
        .past-analysis-item { border-bottom: 1px solid var(--container-border); padding: 10px 0; }
        .tags-input { flex-grow: 1; min-width: 200px; }
        .dashboard-controls { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .action-buttons button { margin-right: 10px; background-color: #6c757d; font-size: 14px; padding: 8px 12px; }
        .key-info-card { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background-color: var(--pre-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .info-item { display: flex; flex-direction: column; }
        .info-item .label { font-size: 0.9em; color: #888; }
        .info-item .value { font-size: 1.1em; font-weight: bold; }
    </style>
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>LexiGuard</h1>
        <div class="header-controls">
            <div id="help-btn" class="help-button" title="Start Guided Tour">‚ùì</div>
            <div id="theme-toggle" class="theme-switch" title="Toggle Dark/Light Mode">üåô</div>
            <div id="user-info" class="hidden"><span id="user-email"></span><button id="logout-button" style="margin-left: 15px;">Logout</button></div>
        </div>
    </div>
    <div id="auth-section">
        <div id="login-container" class="auth-container">
            <h2>Login</h2>
            <div class="auth-form">
                <input type="email" id="login-email" placeholder="Email"><input type="password" id="login-password" placeholder="Password"><button id="login-button">Login</button>
                <p>Don't have an account? <span id="auth-toggle" onclick="toggleAuthForms()">Sign up</span></p>
            </div>
        </div>
        <div id="signup-container" class="auth-container hidden">
            <h2>Sign Up</h2>
            <div class="auth-form">
                <input type="email" id="signup-email" placeholder="Email"><input type="password" id="signup-password" placeholder="Password"><button id="signup-button">Sign Up</button>
                <p>Already have an account? <span id="auth-toggle" onclick="toggleAuthForms()">Login</span></p>
            </div>
        </div>
    </div>
    <div id="app-content" class="hidden">
        <div class="container" id="main-analyzer">
            <h3>1. Analyze New Document</h3>
            <div class="upload-controls">
                <input type="text" id="tags-input" class="tags-input" placeholder="Add tags, comma-separated (e.g., rental, 2025)">
                <select id="language-selector"><option value="English">English</option><option value="Hinglish">Hinglish</option><option value="Hindi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option><option value="Telugu">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option><option value="Tamil">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option><option value="Gujarati">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</option></select>
                <input type="file" id="doc-uploader" accept=".pdf,.docx,.doc,.png,.jpg,.jpeg">
                <button onclick="handleAnalyze()">Analyze</button>
            </div>
            <p id="upload-status" style="font-weight: bold;"></p>
        </div>
        <div id="loader" class="hidden"></div>
        <div id="results" class="hidden">
            <hr>
            <div class="analysis-section"><h3>‚≠ê Key Information & Scores</h3><div id="key-info-card" class="key-info-card"></div></div>
            <div class="action-buttons"><button onclick="handleExport()">Export as PDF</button><button onclick="handleShare()">Share Analysis</button></div>
            <div class="analysis-section"><h3>‚úÖ Summary & Action Plan</h3><pre id="summary-text" class="summary-analysis"></pre></div>
            <div class="analysis-section"><h3>üö® Risk Radar</h3><pre id="risk-text" class="risk-analysis"></pre></div>
            <div class="analysis-section"><h3>‚ùì Questions You Should Ask</h3><pre id="questions-text"></pre></div>
            <div class="analysis-section"><h3>‚ö†Ô∏è What Might Be Missing</h3><pre id="missing-clauses-text" class="missing-analysis"></pre></div>
            <div class="analysis-section"><h3>üìú Legal Formalities & Guidance</h3><pre id="stamp-duty-text"></pre></div>
        </div>
        <div id="dashboard" class="dashboard-container">
            <h2>Your Document History</h2>
            <div class="dashboard-controls"><input type="text" id="search-input" placeholder="Search by tag..."><button onclick="handleSearch()">Search</button></div>
            <div id="past-analyses-list"></div>
        </div>
        <div class="feature-container container" id="clause-analyzer">
            <h3>Clause Deep Dive</h3>
            <p>Paste a single confusing clause from your document for a detailed explanation.</p>
            <textarea id="clause-input" placeholder="Paste your clause here..."></textarea>
            <button onclick="handleClauseAnalyze()">Analyze Clause</button>
            <pre id="clause-result" class="hidden"></pre>
        </div>
        <div class="feature-container container" id="document-comparer">
            <h3>Document Comparison ("What's Changed?")</h3>
            <p>Upload an old and new version of a document to see the differences.</p>
            <div>Old Document: <input type="file" id="doc-a-uploader" accept=".pdf,.docx,.doc,.png,.jpg,.jpeg"></div>
            <div>New Document: <input type="file" id="doc-b-uploader" accept=".pdf,.docx,.doc,.png,.jpg,.jpeg"></div>
            <button onclick="handleCompare()">Compare Documents</button>
            <pre id="compare-result" class="hidden"></pre>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyA33tEkjkJjoZr0l-DNxwevv9phRA9GkjY",
            authDomain: "lexiguide-hackathon-2025.firebaseapp.com",
            projectId: "lexiguide-hackathon-2025",
            storageBucket: "lexiguide-hackathon-2025.firebasestorage.app",
            messagingSenderId: "814528861476",
            appId: "1:814528861476:web:7d3ce97018abd1a8dc0fb1",
            measurementId: "G-FHQW7RH75X"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentDocId = null;

        // --- UI ELEMENTS ---
        const authSection = document.getElementById('auth-section');
        const appContent = document.getElementById('app-content');
        const userInfo = document.getElementById('user-info');
        const userEmailSpan = document.getElementById('user-email');
        const loginContainer = document.getElementById('login-container');
        const signupContainer = document.getElementById('signup-container');
        const themeToggle = document.getElementById('theme-toggle');
        const helpBtn = document.getElementById('help-btn');

        // --- AUTH LOGIC ---
        window.toggleAuthForms = function() {
            loginContainer.classList.toggle('hidden');
            signupContainer.classList.toggle('hidden');
        }
        onAuthStateChanged(auth, user => {
            if (user) {
                authSection.classList.add('hidden');
                appContent.classList.remove('hidden');
                userInfo.classList.remove('hidden');
                userEmailSpan.textContent = user.email;
                loadUserDocuments(user.uid);
                if (!localStorage.getItem('lexiguide_tour_completed')) {
                    setTimeout(startTour, 1000);
                }
            } else {
                authSection.classList.remove('hidden');
                appContent.classList.add('hidden');
                userInfo.classList.add('hidden');
                userEmailSpan.textContent = '';
            }
        });
        document.getElementById('signup-button').addEventListener('click', () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            createUserWithEmailAndPassword(auth, email, password).catch(error => alert(error.message));
        });
        document.getElementById('login-button').addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, password).catch(error => alert(error.message));
        });
        document.getElementById('logout-button').addEventListener('click', () => {
            signOut(auth);
        });

        // --- CORE APP LOGIC ---
        window.handleAnalyze = async function() {
            const user = auth.currentUser;
            if (!user) { alert("Please log in."); return; }
            const uploader = document.getElementById('doc-uploader');
            if (uploader.files.length === 0) { alert("Please select a PDF file."); return; }
            const file = uploader.files[0];
            const formData = new FormData();
            formData.append('document', file);
            formData.append('language', document.getElementById('language-selector').value);
            formData.append('filename', file.name);
            formData.append('tags', document.getElementById('tags-input').value);
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            const uploadStatusP = document.getElementById('upload-status');
            if (uploadStatusP) uploadStatusP.textContent = 'Analyzing... this may take a moment.';
            try {
                const token = await user.getIdToken();
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "Analysis failed.");
                }
                const data = await response.json();
                currentDocId = data.doc_id;
                populateKeyInfoCard(data.key_info);
                document.getElementById('summary-text').textContent = data.summary_and_checklist;
                document.getElementById('risk-text').textContent = data.risk_analysis;
                document.getElementById('questions-text').textContent = data.questions_to_ask;
                document.getElementById('missing-clauses-text').textContent = data.missing_clauses;
                document.getElementById('stamp-duty-text').textContent = data.legal_formalities_guidance;
                makeAnalysisInteractive('summary-text');
                makeAnalysisInteractive('risk-text');
                document.getElementById('results').classList.remove('hidden');
                if (uploadStatusP) uploadStatusP.textContent = 'Analysis complete!';
                uploader.value = '';
                loadUserDocuments(user.uid);
            } catch (error) {
                alert("Error: " + error.message);
                if (uploadStatusP) uploadStatusP.textContent = '';
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }
        window.handleSearch = function() {
            const user = auth.currentUser;
            if (!user) return;
            const searchTerm = document.getElementById('search-input').value;
            loadUserDocuments(user.uid, searchTerm.trim().toLowerCase());
        }
        async function loadUserDocuments(userId, searchTerm = null) {
            const listElement = document.getElementById('past-analyses-list');
            listElement.innerHTML = "Loading history...";
            try {
                let documentsQuery;
                const documentsColRef = collection(db, 'users', userId, 'documents');
                if (searchTerm) {
                    documentsQuery = query(documentsColRef, where("tags", "array-contains", searchTerm), orderBy('analyzedAt', 'desc'));
                } else {
                    documentsQuery = query(documentsColRef, orderBy('analyzedAt', 'desc'));
                }
                const querySnapshot = await getDocs(documentsQuery);
                listElement.innerHTML = "";
                if (querySnapshot.empty) {
                    listElement.innerHTML = `<p>No documents found${searchTerm ? ' with that tag' : ''}.</p>`;
                    return;
                }
                querySnapshot.forEach(docSnap => {
                    const docData = docSnap.data();
                    const item = document.createElement('div');
                    item.className = 'past-analysis-item';
                    item.innerHTML = `
                        <h4>${docData.filename} (${docData.doc_type})</h4>
                        <p>Analyzed on: ${docData.analyzedAt.toDate().toLocaleString()}</p>
                        ${docData.tags && docData.tags.length > 0 ? `<p>Jurisdiction: ${docData.jurisdiction || 'N/A'}<br>Tags: ${docData.tags.join(', ')}</p>` : ''}
                        <button onclick="viewAnalysis('${docSnap.id}')">View Analysis</button>
                    `;
                    listElement.appendChild(item);
                });
            } catch(error) {
                console.error("Error loading documents:", error);
                listElement.innerHTML = "<p>Could not load document history.</p>";
            }
        }
        window.viewAnalysis = async function(docId) {
            const user = auth.currentUser;
            if (!user) return;
            const docRef = doc(db, 'users', user.uid, 'documents', docId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                currentDocId = docId;
                populateKeyInfoCard(data.key_info);
                document.getElementById('summary-text').textContent = data.summary_and_checklist;
                document.getElementById('risk-text').textContent = data.risk_analysis;
                document.getElementById('questions-text').textContent = data.questions_to_ask;
                document.getElementById('missing-clauses-text').textContent = data.missing_clauses;
                document.getElementById('stamp-duty-text').textContent = data.legal_formalities_guidance || data.stamp_duty_guidance;
                makeAnalysisInteractive('summary-text');
                makeAnalysisInteractive('risk-text');
                document.getElementById('results').classList.remove('hidden');
                window.scrollTo(0, 0);
            } else {
                alert("Could not find analysis.");
            }
        }
        function populateKeyInfoCard(keyInfo) {
            const keyInfoCard = document.getElementById('key-info-card');
            keyInfoCard.innerHTML = '';
            if (!keyInfo || Object.keys(keyInfo).length === 0) {
                keyInfoCard.innerHTML = '<p>No structured key information was extracted.</p>';
                return;
            }
            const createScoreVisual = (score) => {
                let stars = '';
                for (let i = 0; i < 10; i++) {
                    stars += i < score ? '‚òÖ' : '‚òÜ';
                }
                return `<span style="color: #f0ad4e;">${stars}</span> (${score}/10)`;
            };
            for (const [key, value] of Object.entries(keyInfo)) {
                const item = document.createElement('div');
                item.className = 'info-item';
                const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                let displayValue = value;
                if (key === 'readability_score' || key === 'fairness_score') {
                    displayValue = createScoreVisual(value);
                }
                item.innerHTML = `<span class="label">${label}</span><span class="value">${displayValue}</span>`;
                keyInfoCard.appendChild(item);
            }
        }
        window.handleExport = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("LexiGuard - Document Analysis", 10, 10);
            doc.text("Summary & Action Plan", 10, 20);
            doc.text(document.getElementById('summary-text').innerText, 10, 30, { maxWidth: 180 });
            doc.addPage();
            doc.text("Risk Radar", 10, 10);
            doc.text(document.getElementById('risk-text').innerText, 10, 20, { maxWidth: 180 });
            doc.save("LexiGuide-Analysis.pdf");
        }
        window.handleShare = async function() {
            const user = auth.currentUser;
            if (!user || !currentDocId) {
                alert("Please view an analysis before sharing."); return;
            }
            try {
                const token = await user.getIdToken();
                const response = await fetch('/create_share_link', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ doc_id: currentDocId })
                });
                if (!response.ok) {
                    const errorData = await response.json(); throw new Error(errorData.error);
                }
                const data = await response.json();
                const shareLink = `${window.location.origin}/share.html?id=${data.share_id}`;
                prompt("Here is your shareable link:", shareLink);
            } catch (error) {
                alert("Could not create share link: " + error.message);
            }
        }
        
        // --- STANDALONE FEATURE LOGIC ---
        window.handleClauseAnalyze = async function() {
            const clauseText = document.getElementById('clause-input').value;
            const language = document.getElementById('language-selector').value;
            if (!clauseText.trim()) { alert("Please paste a clause to analyze."); return; }
            const resultPre = document.getElementById('clause-result');
            resultPre.textContent = "Analyzing...";
            resultPre.classList.remove('hidden');
            try {
                const response = await fetch('/analyze_clause', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clause_text: clauseText, language: language })
                });
                if (!response.ok) { throw new Error((await response.json()).error); }
                const data = await response.json();
                resultPre.textContent = data.explanation;
            } catch (error) {
                resultPre.textContent = "Error: " + error.message;
            }
        }
        window.handleCompare = async function() {
            const docAUploader = document.getElementById('doc-a-uploader');
            const docBUploader = document.getElementById('doc-b-uploader');
            if (docAUploader.files.length === 0 || docBUploader.files.length === 0) {
                alert("Please upload both documents."); return;
            }
            const formData = new FormData();
            formData.append('doc_a', docAUploader.files[0]);
            formData.append('doc_b', docBUploader.files[0]);
            formData.append('language', document.getElementById('language-selector').value);
            const resultPre = document.getElementById('compare-result');
            resultPre.textContent = "Comparing...";
            resultPre.classList.remove('hidden');
            try {
                const response = await fetch('/compare', { method: 'POST', body: formData });
                if (!response.ok) { throw new Error((await response.json()).error); }
                const data = await response.json();
                resultPre.textContent = data.comparison;
            } catch (error) {
                resultPre.textContent = "Error: " + error.message;
            }
        }

        // --- UI ENHANCEMENT LOGIC ---
        const LEGAL_TERMS = ["indemnity", "escrow", "lessee", "lessor", "collateral", "tenure", "sublet", "arbitration", "liability", "jurisdiction", "notary", "stamp duty", "force majeure", "annexure", "perpetuity", "waiver"];
        function makeAnalysisInteractive(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            let content = element.textContent;
            LEGAL_TERMS.forEach(term => {
                const regex = new RegExp(`\\b(${term})\\b`, 'gi');
                content = content.replace(regex, `<span class="legal-term" onclick="handleTermClick(this)">$1</span>`);
            });
            element.innerHTML = content;
        }
        window.handleTermClick = async function(element) {
            const term = element.innerText.toLowerCase();
            const language = document.getElementById('language-selector').value;
            try {
                const response = await fetch('/explain_term', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ term, language })
                });
                if (!response.ok) throw new Error("Could not fetch explanation.");
                const data = await response.json();
                alert(`"${term.charAt(0).toUpperCase() + term.slice(1)}"\n\n${data.explanation}`);
            } catch (error) {
                alert(`Could not get an explanation for "${term}".`);
            }
        }
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme) {
            document.documentElement.setAttribute('data-theme', currentTheme);
            if (currentTheme === 'dark') themeToggle.textContent = '‚òÄÔ∏è';
        }
        themeToggle.addEventListener('click', () => {
            let theme = document.documentElement.getAttribute('data-theme');
            if (theme === 'dark') {
                document.documentElement.removeAttribute('data-theme');
                localStorage.removeItem('theme');
                themeToggle.textContent = 'üåô';
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = '‚òÄÔ∏è';
            }
        });
        const tourSteps = [
            { element: '#main-analyzer', title: 'Welcome to LexiGuard!', text: 'This is the main analysis tool. Let\'s quickly go over the key features.' },
            { element: '#tags-input', title: '1. Add Tags', text: 'Before uploading, add tags to organize and search for your documents later.' },
            { element: '#dashboard', title: '2. Document History', text: 'All your past analyses are saved here. You can search them by the tags you added.' },
            { element: '#clause-analyzer', title: '3. Clause Deep Dive', text: 'Have a specific, confusing clause? Paste it here for a focused analysis.' },
            { element: '#document-comparer', title: '4. Compare Documents', text: 'Upload two versions of a document to see exactly what has changed.' },
            { element: '#theme-toggle', title: 'Toggle Theme', text: 'Finally, you can switch between light and dark mode anytime.' }
        ];
        function showTourStep(index) {
            const existingTourStep = document.querySelector('.tour-step');
            if (existingTourStep) existingTourStep.remove();
            if (index >= tourSteps.length) { localStorage.setItem('lexiguide_tour_completed', 'true'); return; }
            const step = tourSteps[index];
            const targetElement = document.querySelector(step.element);
            if (!targetElement) return;
            const tourStepDiv = document.createElement('div');
            tourStepDiv.className = 'tour-step';
            const targetRect = targetElement.getBoundingClientRect();
            let top = targetRect.bottom + 10;
            let left = targetRect.left;
            if ((top + 180) > window.innerHeight) { top = targetRect.top - 190; }
            if (left < 10) { left = 10; }
            if ((left + 350) > window.innerWidth) { left = window.innerWidth - 360; }
            tourStepDiv.style.left = `${left}px`;
            tourStepDiv.style.top = `${top}px`;
            tourStepDiv.innerHTML = `
                <h4>${step.title}</h4><p>${step.text}</p>
                <div class="tour-nav">
                    <button id="tour-prev" ${index === 0 ? 'disabled' : ''}>Prev</button>
                    <button id="tour-next">${index === tourSteps.length - 1 ? 'Finish' : 'Next'}</button>
                </div>`;
            document.body.appendChild(tourStepDiv);
            document.getElementById('tour-next').onclick = () => showTourStep(index + 1);
            if(index > 0) document.getElementById('tour-prev').onclick = () => showTourStep(index - 1);
        }
        function startTour() { showTourStep(0); }
        helpBtn.addEventListener('click', startTour);
    </script>
</body>
</html>